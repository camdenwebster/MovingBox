#!/usr/bin/env bash

set -euo pipefail

repo_root="$(git rev-parse --show-toplevel)"
cd "$repo_root"

swift_files=()
while IFS= read -r -d '' file; do
  case "$file" in
    *.swift) swift_files+=("$file") ;;
  esac
done < <(git diff --cached --name-only --diff-filter=ACMR -z)

if [ "${#swift_files[@]}" -eq 0 ]; then
  exit 0
fi

if ! xcrun --find swift-format >/dev/null 2>&1; then
  echo "pre-commit: swift-format not found via xcrun; install swift-format to continue."
  exit 1
fi

config_args=()
if [ -f ".swift-format" ]; then
  config_args=(--configuration ".swift-format")
fi

echo "pre-commit: formatting staged Swift files..."
xcrun swift-format format --in-place --parallel "${config_args[@]}" "${swift_files[@]}"

git add -- "${swift_files[@]}"

echo "pre-commit: linting staged Swift files..."
xcrun swift-format lint --strict --parallel "${config_args[@]}" "${swift_files[@]}"

echo "pre-commit: format + lint passed."
